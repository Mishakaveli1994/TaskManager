{% extends 'base.html' %}
{% load static %}
{% load auth_filter %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/task-details.css' %}">
{% endblock css %}

{% block title %}Task Details{% endblock title %}

{% block content %}
    <div class="container">
        <h1>{{ task.title }}</h1>
        <div class="task-container">
            <div class="task-top-cont">
                <div class="task-details">
                    <div id="priority">
                        <p class="priority">Priority:</p>
                        <div class="inner-field">
                            <p class="priority {{ task.priority }}">{{ task.priority|title }}</p>
                            {% if request.user == task.author or request.user|has_group:"Admin" %}
                                <a href="#" class="dropdown"><i class="fa-solid fa-pencil dropdown"></i></a>
                            {% endif %}
                        </div>
                    </div>
                    <div id="priority-dropdown" class="dropdown">
                        <a href="#">Low</a>
                        <a href="#">Medium</a>
                        <a href="#">High</a>
                    </div>
                    <div id="status">
                        <p class="status">Status:</p>
                        <div class="inner-field">
                            <p class="status  {{ task.status.split|lower|join:"-" }}">{{ task.status|title }}</p>
                            {% if request.user == task.author or request.user|has_group:"Admin" or request.user == task.assignee %}
                                <a href="#" class="dropdown"><i class="fa-solid fa-pencil dropdown"></i></a>
                            {% endif %}
                        </div>
                    </div>
                    <div id="status-dropdown" class="dropdown">
                        <a href="#">Opened</a>
                        <a href="#">In Progress</a>
                        <a href="#">Blocked</a>
                        <a href="#">Completed</a>
                    </div>
                    <div id="resolution">
                        <p class="resolution">Resolution:</p>
                        <div class="inner-field">
                            <p class="resolution {{ task.resolved }}">{{ task.resolved|title }}</p>
                            {% if request.user == task.author or request.user|has_group:"Admin" or request.user == task.assignee %}
                                <a href="#" class="dropdown"><i class="fa-solid fa-pencil dropdown"></i></a>
                            {% endif %}
                        </div>
                    </div>
                    <div id="resolution-dropdown" class="dropdown">
                        <a href="#">Unresolved</a>
                        <a href="#">Resolved</a>
                    </div>
                    <div id="parent-task">
                        <p class="parent-task">Parent Task</p>
                        <div class="inner-field">
                            {% if task.parent_task %}
                                <a href="{{ task.parent_task.id }}">{{ task.parent_task }}</a>
                            {% else %}
                                <p>None</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <textarea rows="20" cols="60">{{ task.description }}</textarea>
            </div>
            <div class="task-info">
                <p class="header-p">People</p>
                <div class="people">
                    <div class="assignee">
                        <p class="assignee">Assignee:</p>
                        <div class="assignee-img">
                            {% if task.assignee.profile.photo %}
                                <img src="{{ task.assignee.profile.photo.url }}" alt="">
                            {% else %}
                                <img src="{% static 'img/no_photo.png' %}" alt="">
                            {% endif %}
                            {% if task.assignee %}
                                <a class="assignee" href="/account/profile/{{ task.assignee }}">{{ task.assignee }}</a>
                            {% else %}
                                <p>None</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="author">
                        <p class="author">Reporter:</p>
                        <div class="author-img">
                            {% if task.author.profile.photo.url %}
                                <img src="{{ task.author.profile.photo.url }}" alt="">
                            {% else %}
                                <img src="{% static 'img/no_photo.png' %}" alt="">
                            {% endif %}
                            <a class="author" href="/account/profile/{{ task.author }}">{{ task.author }}</a>
                        </div>
                    </div>
                </div>

                <div class="dates-container">
                    <p class="header-p">Dates</p>
                    <div class="dates">
                        <div class="dates-left">
                            <p class="created">Created:</p>
                            <p class="updated">Last updated:</p>
                        </div>
                        <div class="dates-right">
                            <p>{{ task.publish|date:"D d M Y H:i" }}</p>
                            <p>{{ task.updated|timesince }} ago</p>
                        </div>
                    </div>
                </div>

                <div class="time-tracking-container">
                    <p class="header-p">Time Tracking</p>
                    <div class="time-tracking">
                        <div class="time-tracking-left">
                            <p class="estimated">Estimated:</p>
                            <p class="remaining">Remaining:</p>
                            <p class="logged">Logged:</p>
                        </div>
                        <div class="time-tracking-right">
                            <p class="estimated">{{ task.estimate }}H</p>
                            {% with task.estimate|sub:task.tracked_time as remaining %}
                                {% if remaining < 0 %}
                                    <p class="remaining">0H</p>
                                {% else %}
                                    <p class="remaining">{{ remaining }}H
                                {% endif %}
                            {% endwith %}
                            <p class="logged">{{ task.tracked_time }}H</p>
                        </div>
                    </div>
                </div>

                <div class="subtasks-container">
                    <p class="header-p">Subtasks</p>
                    <div class="subtasks">
                        <div class="subtasks-header">
                            <p>Task</p>
                            <p>Status</p>
                            <p>Priority</p>
                        </div>
                        {% for task in subtasks %}
                            <div class="subtask">
                                <a href="/tasks/{{ task.id }}">{{ task|truncatechars:30 }}</a>
                                <p class="{{ task.status|join:"-" }}">{{ task.status|title }}</p>
                                <p class="{{ task.priority }}">{{ task.priority|title }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% if request.user == task.author or request.user|has_group:"Admin" or request.user == task.assignee %}
            <div id="update-container">
                <button id="update-task">Update Task</button>
            </div>
        {% endif %}
    </div>
    {% csrf_token %}
{% endblock content %}

{% block script %}
    <script>
        window.onload = function () {
            let editMenu = document.querySelectorAll(".inner-field a");
            let dropdownMenus = document.querySelectorAll("div.dropdown");
            let updateBtn = document.getElementById("update-task");

            updateBtn.addEventListener('click', updateTask)

            async function updateTask(ev) {
                let csrf_token = document.querySelector('input[name="csrfmiddlewaretoken"]').value
                let data = {
                    'priority': document.querySelector('.inner-field .priority').innerText,
                    'status': document.querySelector('.inner-field .status').innerText,
                    'resolution': document.querySelector('.inner-field .resolution').innerText,
                    'assignee': document.querySelector('a.assignee').innerText,
                    'logged': document.querySelector('p.logged').innerText.slice(0, -1),
                    'title': document.querySelector('.container h1').innerText,
                    'description': document.querySelector('textarea').value,
                }

                let request = await fetch('{% url 'update_task' task.id  %}',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            "X-CSRFToken": csrf_token,
                        },
                        body: JSON.stringify(data)
                    }
                )
                console.log(await request.json())
            }

            const innerPriority = document.querySelector('.inner-field .priority').innerText
            const innerStatus = document.querySelector('.inner-field .status').innerText
            const innerResolution = document.querySelector('.inner-field .resolution').innerText

            let initialValues = {
                'priority-dropdown': innerPriority,
                'status-dropdown': innerStatus,
                'resolution-dropdown': innerResolution,
            };


            [...editMenu].map(x => x.addEventListener("click", openMenu));
            [...dropdownMenus].map(x => x.addEventListener("click", changeItem));

            let toggleMap = {
                'status': document.getElementById('status-dropdown'),
                'priority': document.getElementById('priority-dropdown'),
                'resolution': document.getElementById('resolution-dropdown'),
            }
            let menuMap = {
                'status-dropdown': document.querySelector('.inner-field .status'),
                'priority-dropdown': document.querySelector('.inner-field .priority'),
                'resolution-dropdown': document.querySelector('.inner-field .resolution'),
            }

            function openMenu(ev) {
                let parentElement = ev.target.parentNode.parentNode.parentNode
                let element = toggleMap[parentElement.id]
                element.classList.toggle('show');
            }

            function changeItem(ev) {
                let elementId = ev.target.parentNode.id
                let element = menuMap[elementId]
                let value = element.innerText.toLowerCase()
                closeOptions(element)
                element.innerText = ev.target.innerText
                element.classList.remove(value)
                if (ev.target.innerText.toLowerCase() === 'in progress') {
                    element.classList.remove(value)
                    element.classList.add('in-progress')
                } else {
                    element.classList.remove('in-progress')
                    element.classList.add(ev.target.innerText.toLowerCase())
                }
                if (element.innerText.toLowerCase() !== initialValues[elementId].toLowerCase()) {
                    element.style.fontWeight = 'bold';
                } else {
                    element.style.fontWeight = 'normal';
                }
            }
        }


        window.onclick = function (event) {
            if (!event.target.matches('.dropdown')) {
                let dropdowns = document.getElementsByClassName("dropdown");
                let i;
                for (i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function closeOptions(activeMenu) {
            let dropdowns = document.querySelectorAll("div.dropdown");
            [...dropdowns].map(x => x.classList.contains('show') && x !== activeMenu ? x.classList.remove('show') : '')
        }
    </script>
{% endblock script %}